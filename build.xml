<?xml version="1.0" encoding="UTF-8"?>
<project name="testNG-nk4" default="package">
  <property name="version" value="0_3"/>

  <taskdef name="testng"
           classpath="lib/testng-5.14.10.jar"
           classname="org.testng.TestNGAntTask" />

  <path id="base.path">
    <pathelement path="build/class"/>
    <fileset dir="lib">
      <include name="*.jar"/>
    </fileset>
  </path>

  <path id="build.path">
    <path refid="base.path"/>
    <fileset dir="build/modules/"/>
    <fileset dir="build/lib/"/>
  </path>

  <target name="init">
    <mkdir dir="build"/>
    <mkdir dir="build/class"/>
    <mkdir dir="test/build"/>
  </target>
  
  <target name="clean">
    <delete dir="build"/>
    <delete file="testNG-nk4.jar"/>
    <delete dir="${basedir}">
      <include name="testNG-nk4*.zip"/>
    </delete>
    <delete dir="nk-distribution"/>
    <delete file="testNG-nk4.jar"/>
  </target>

  <target name="download-modules" depends="init">
    <delete dir="build/lib"/>
    <delete dir="build/modules"/>

    <javac classpathref="base.path"
           srcdir="src"
           destdir="build/class"
           debug="true"
           target="1.5"
           includes="**/DownloadFromRepository.java"/>
    <java classpathref="base.path"
          classname="uk.org.onegch.netkernel.testNG.DownloadFromRepository"/>
  </target>
  
  <target name="build" depends="init, download-modules">
    <javac classpathref="build.path"
           srcdir="src"
           destdir="build/class"
           debug="true"
           target="1.5"
           excludes="**/DownloadFromRepository.java"/>
  </target>

  <target name="jar" depends="build">
    <delete file="testNG-nk4.jar"/>
    <jar destfile="testNG-nk4.jar">
      <zipfileset dir="build/class" prefix="" excludes="**/DownloadFromRepository.class"/>
      <zipfileset dir="build/modules" prefix="modules" />
      <zipfileset dir="src" prefix="src" excludes="build.xml" />
      <zipfileset file="generate-suite.xsl" prefix=""/>
      <zipfileset dir="etc" prefix="etc">
        <include name="**/KernelLogConfig.xml"/>
        <include name="**/logLevels.xml"/>
      </zipfileset>
    </jar>    
  </target>
  
  <target name="package" depends="jar">
    <delete file="testNG-nk4-${version}.zip"/>
    <zip destfile="testNG-nk4-${version}.zip">
      <zipfileset dir="test" prefix="testNG-nk4-${version}/test" />
      <zipfileset file="testNG-nk4.jar" prefix="testNG-nk4-${version}/"/>
      <zipfileset dir="lib" prefix="testNG-nk4-${version}/lib"/>
      <zipfileset dir="etc" prefix="testNG-nk4-${version}/etc"/>
      <zipfileset dir="build/lib" prefix="testNG-nk4-${version}/nk-distribution/lib"/>
      <zipfileset dir="build/modules" prefix="testNG-nk4-${version}/nk-distribution/modules"/>
      <zipfileset file="generate-suite.xsl" prefix="testNG-nk4-${version}/"/>
    </zip>
  </target>

  <path id="test.path">
    <file file="testNG-nk4.jar"/>
    <pathelement path="test/build/"/>
    <fileset file="build/lib/*.jar"/>
    <fileset dir="lib">
      <include name="http*.jar"/>
      <include name="commons*.jar"/>
      <include name="dom4j*.jar"/>
      <include name="jaxen*.jar"/>
      <include name="testng*.jar"/>
    </fileset>
  </path>

  <target name="compile-test" depends="init,jar,download-modules">
    <javac classpathref="test.path"
           srcdir="test/src"
           destdir="test/build"
           debug="true"
           target="1.5"/>
  </target>

  <target name="test" depends="compile-test, jar">
    <delete dir="test/log"/>
    <mkdir dir="test/log"/>
    <testng classpathref="test.path" outputdir="test/report">
      <classfileset dir="test/build/" includes="**/*.class" />
    </testng>
  </target>
</project>