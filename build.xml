<?xml version="1.0" encoding="UTF-8"?>
<project name="testNG-nk4" default="package">
  <property name="nk-distribution-jar" value="${user.home}/Library/NetKernel/1060-NetKernel-SE-4.1.1.jar"/>
  <property name="version" value="0_3"/>

  <taskdef name="testng"
           classpath="lib/testng-5.14.10.jar"
           classname="org.testng.TestNGAntTask" />

  <path id="path">
    <pathelement path="build/"/>
    <fileset dir="nk-distribution/lib">
      <include name="*.jar"/>
    </fileset>
    <fileset dir="lib">
      <include name="*.jar"/>
    </fileset>
  </path>

  <target name="init">
    <mkdir dir="build"/>
    <mkdir dir="test/build"/>
  </target>
  
  <target name="clean">
    <delete dir="build"/>
    <delete file="testNG-nk4.jar"/>
    <delete dir="${basedir}">
      <include name="testNG-nk4*.zip"/>
    </delete>
    <delete dir="nk-distribution"/>
    <delete file="testNG-nk4.jar"/>
  </target>
  
  <target name="build-from-distribution">
    <unjar src="${nk-distribution-jar}" dest="nk-distribution">
      <patternset>
        <include name="lib/*.jar"/>
        <include name="modules/*.sjar"/>
        <include name="modules/*.jar"/>
        <exclude name="modules/*.apposite.*"/>
        <exclude name="modules/*arp*"/>
        <exclude name="modules/*deadlock*"/>
        <exclude name="modules/*installer*"/>
        <exclude name="modules/*frontend*"/>
      </patternset>
    </unjar>
    <unjar src="${nk-distribution-jar}" dest="${basedir}">
      <patternset>
        <include name="etc/license/*"/>
      </patternset>
    </unjar>
  </target>
  
  <target name="build" depends="init,build-from-distribution">
    <javac classpathref="path"
           srcdir="src"
           destdir="build"
           debug="true"
           target="1.5"/>
  </target>

  <target name="jar" depends="build">
    <jar destfile="testNG-nk4.jar">
      <zipfileset dir="build" prefix=""/>
      <zipfileset dir="src" prefix="src" excludes="build.xml" />
      <zipfileset file="generate-suite.xsl" prefix=""/>
      <zipfileset dir="nk-distribution/modules" prefix="modules"/>
      <zipfileset dir="modules" prefix="modules"/>
      <zipfileset dir="etc" prefix="etc">
        <include name="**/KernelLogConfig.xml"/>
        <include name="**/logLevels.xml"/>
      </zipfileset>
    </jar>    
  </target>
  
  <target name="package" depends="jar">
    <zip destfile="testNG-nk4-${version}.zip">
      <zipfileset dir="test" prefix="testNG-nk4-${version}/test" />
      <zipfileset file="testNG-nk4.jar" prefix="testNG-nk4-${version}/"/>
      <zipfileset dir="lib" prefix="testNG-nk4-${version}/lib"/>
      <zipfileset dir="etc" prefix="testNG-nk4-${version}/etc"/>
      <zipfileset dir="modules" prefix="testNG-nk4-${version}/modules"/>
      <zipfileset dir="nk-distribution/lib" prefix="testNG-nk4-${version}/nk-distribution/lib"/>
      <zipfileset dir="nk-distribution/modules" prefix="testNG-nk4-${version}/nk-distribution/modules"/>
      <zipfileset file="generate-suite.xsl" prefix="testNG-nk4-${version}/"/>
    </zip>
  </target>

  <path id="test.path">
    <file file="testNG-nk4.jar"/>
    <pathelement path="test/build/"/>
    <fileset file="nk-distribution/lib/*.jar"/>
    <fileset dir="lib">
      <include name="http*.jar"/>
      <include name="commons*.jar"/>
      <include name="dom4j*.jar"/>
      <include name="jaxen*.jar"/>
      <include name="testng*.jar"/>
    </fileset>
  </path>

  <target name="compile-test" depends="init,jar">
    <javac classpathref="test.path"
           srcdir="test/src"
           destdir="test/build"
           debug="true"
           target="1.5"/>
  </target>

  <target name="test" depends="compile-test, jar">
    <delete dir="test/log"/>
    <mkdir dir="test/log"/>
    <testng classpathref="test.path" outputdir="test/report">
      <classfileset dir="test/build/" includes="**/*.class" />
    </testng>
  </target>
</project>